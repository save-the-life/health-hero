# 🎁 프로모션 테스트 가이드

Health Hero 프로젝트의 토스 프로모션 기능 테스트 방법을 안내합니다.

## 📋 사전 준비

### 1. Supabase 마이그레이션 실행
```bash
# promotion_records 테이블 생성
supabase db push
```

### 2. 환경 변수 확인
`.env.local` 파일에 Supabase 설정이 있는지 확인하세요.

```env
NEXT_PUBLIC_SUPABASE_URL=your_supabase_url
NEXT_PUBLIC_SUPABASE_ANON_KEY=your_supabase_key
```

## 🧪 테스트 플로우

### 1단계: 앱 실행 및 로그인
```bash
npm run dev
```

1. 브라우저에서 `http://localhost:3000` 접속
2. "토스 로그인" 버튼 클릭
3. 토스 로그인 완료 (게임 유저 키 자동 획득 및 저장)

### 2단계: 프로모션 테스트 실행

#### 방법 1: 테스트 버튼 사용 (개발 모드)
1. 게임 페이지(`/game`)로 이동
2. 왼쪽 하단의 **"🧪 프로모션 테스트"** 버튼 확인
3. **"퀴즈 풀러가기"** 버튼 클릭
4. 프로모션이 자동으로 지급되고 메인 페이지로 이동
5. 상단에 결과 토스트 표시 확인

#### 결과 예시:
- ✅ **성공**: 
  ```
  🎉 프로모션 지급 성공!
  10원의 토스 포인트를 받았어요!
  첫 퀴즈 풀리기 완료! 리워드 키: reward_xxxxx...
  ```

- ❌ **실패** (중복 지급):
  ```
  ❌ 프로모션 지급 실패
  이미 지급받은 프로모션입니다.
  ```

### 3단계: 결과 확인

#### 콘솔 로그 확인
브라우저 개발자 도구(F12) → Console 탭에서 상세 로그 확인:

```
🎁 [PromotionService] 리워드 지급 시작
[PromotionService] 프로모션 지급 요청: {
  promotionCode: "TEST_01K98ST5FF47JE9WMASGHF45D0",
  amount: 10
}
✅ [PromotionService] 포인트 지급 성공! reward_xxxxx
```

#### Supabase 데이터베이스 확인
Supabase 대시보드 → Table Editor → `promotion_records` 테이블:

| user_id | game_user_hash | condition_type | amount | status | reward_key |
|---------|----------------|----------------|--------|--------|------------|
| uuid... | QUYu-_8y_aN... | FIRST_QUIZ     | 10     | SUCCESS | reward_... |

## 🔍 테스트 케이스

### 1. 정상 지급 테스트
- ✅ 첫 실행 시 프로모션 지급 성공
- ✅ 토스트 메시지 표시
- ✅ DB에 기록 저장

### 2. 중복 지급 방지 테스트
1. 첫 번째 지급 성공 후
2. 다시 "퀴즈 풀러가기" 버튼 클릭
3. ❌ 에러: "이미 지급받은 프로모션입니다." 확인

### 3. 에러 처리 테스트
- 로그인하지 않은 상태에서 테스트
- 게임 유저 키가 없는 상태에서 테스트
- 프로모션 코드가 잘못된 경우

## 📊 프로모션 설정

현재 테스트 가능한 프로모션:

| 조건 | 설명 | 지급 금액 | 프로모션 코드 |
|-----|------|----------|--------------|
| FIRST_QUIZ | 첫 퀴즈 풀리기 | 10원 | TEST_01K98ST5FF47JE9WMASGHF45D0 |

## 🚀 실제 프로모션 전환

테스트 완료 후 실제 프로모션으로 전환하려면:

1. **앱인토스 콘솔**에서 프로모션 검토 승인 대기
2. 승인 완료 후 `src/types/promotion.ts`의 프로모션 코드 변경:
   ```typescript
   // 테스트 → 실제
   FIRST_QUIZ: '01K98ST5FF47JE9WMASGHF45D0'
   ```
3. `src/services/promotionService.ts`의 `grantReward()` 함수에서 `isTest` 파라미터를 `false`로 변경

## 🐛 트러블슈팅

### 문제: "게임 유저 키가 없습니다"
**해결**: 토스 로그인을 다시 시도하세요. 로그인 시 자동으로 게임 유저 키가 생성됩니다.

### 문제: "프로모션이 실행중이 아닙니다" (에러 코드: 4109)
**해결**: 앱인토스 콘솔에서 프로모션이 시작 상태인지 확인하거나, 테스트 프로모션 코드를 사용하고 있는지 확인하세요.

### 문제: "프로모션 예산이 부족합니다" (에러 코드: 4112)
**해결**: 앱인토스 콘솔 → 비즈 월렛에서 예산을 충전하세요.

### 문제: 토스트가 표시되지 않음
**해결**: 
1. 브라우저 콘솔에서 `localStorage.getItem('promotionResult')` 확인
2. 5분 이내에 메인 페이지로 돌아왔는지 확인

## 📝 다음 단계

1. ✅ 테스트 프로모션으로 최소 1회 지급 테스트 완료
2. ⏳ 앱인토스 콘솔에서 프로모션 검토 대기 (1-2영업일)
3. ⏳ 검토 승인 후 실제 프로모션 시작
4. ⏳ 혜택 탭 노출 설정 (선택사항)

## 🔗 참고 문서

- [토스 프로모션 개발 가이드](https://docs.toss.im)
- [앱인토스 콘솔](https://console.toss.im)
- [Supabase 대시보드](https://supabase.com/dashboard)

---

**테스트 성공 시 스크린샷을 남겨주세요!** 📸

