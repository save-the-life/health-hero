# í† ìŠ¤ ë¡œê·¸ì¸ ì„¤ì • ê°€ì´ë“œ

> âœ… **ìƒíƒœ**: ì™„ì „ ì‘ë™ (2025-01-20 í…ŒìŠ¤íŠ¸ ì™„ë£Œ)

## ğŸ“‹ ëª©ì°¨

1. [í™˜ê²½ ë³€ìˆ˜ ì„¤ì •](#í™˜ê²½-ë³€ìˆ˜-ì„¤ì •)
2. [Supabase ì„¤ì •](#supabase-ì„¤ì •)
3. [Supabase Edge Function ë°°í¬](#supabase-edge-function-ë°°í¬)
4. [ë¡œì»¬ ê°œë°œ í…ŒìŠ¤íŠ¸](#ë¡œì»¬-ê°œë°œ-í…ŒìŠ¤íŠ¸)
5. [ìƒŒë“œë°•ìŠ¤ ì•± í…ŒìŠ¤íŠ¸](#ìƒŒë“œë°•ìŠ¤-ì•±-í…ŒìŠ¤íŠ¸)
6. [íŠ¸ëŸ¬ë¸”ìŠˆíŒ…](#íŠ¸ëŸ¬ë¸”ìŠˆíŒ…)

---

## 1. í™˜ê²½ ë³€ìˆ˜ ì„¤ì •

### Supabase ì„¤ì • ê°’ í™•ì¸

1. [Supabase ì½˜ì†”](https://supabase.com/dashboard) ì ‘ì†
2. í”„ë¡œì íŠ¸ ì„ íƒ
3. **Project Settings** > **API** ë©”ë‰´ë¡œ ì´ë™
4. ë‹¤ìŒ ê°’ ë³µì‚¬:
   - **Project URL**: `https://xxxxxxxxxxxx.supabase.co`
   - **anon public key**: `eyJhbG...` (ê¸´ ë¬¸ìì—´)

### ì•±ì¸í† ìŠ¤ ì„¤ì • ê°’ í™•ì¸

1. [ì•±ì¸í† ìŠ¤ ì½˜ì†”](https://developers-apps-in-toss.toss.im) ì ‘ì†
2. í”„ë¡œì íŠ¸ ì„ íƒ
3. **ì•± ì„¤ì •** ë˜ëŠ” **ê¸°ë³¸ ì„¤ì •** í™•ì¸
4. **App Key** (ì•± ì´ë¦„) í™•ì¸: `health-hero`

âš ï¸ **Client IDëŠ” ì„ íƒì‚¬í•­**: í˜„ì¬ í† ìŠ¤ ë¡œê·¸ì¸ êµ¬í˜„ì—ì„œëŠ” ì‚¬ìš©í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.

### .env.local íŒŒì¼ ìƒì„±

í”„ë¡œì íŠ¸ ë£¨íŠ¸ì— `.env.local` íŒŒì¼ì„ ìƒì„±í•˜ê³  ë‹¤ìŒ ë‚´ìš©ì„ ì…ë ¥:

```bash
# Supabase ì„¤ì • (í•„ìˆ˜)
NEXT_PUBLIC_SUPABASE_URL=https://your-project.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=your-anon-key

# í† ìŠ¤ ì•±ì¸í† ìŠ¤ ì„¤ì • (í•„ìˆ˜)
NEXT_PUBLIC_TOSS_APP_KEY=health-hero

# â„¹ï¸ Client ID/Secretì€ í˜„ì¬ í† ìŠ¤ ë¡œê·¸ì¸ í”Œë¡œìš°ì—ì„œ ì‚¬ìš©í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
# NEXT_PUBLIC_TOSS_CLIENT_ID=your-toss-client-id
```

âš ï¸ **ì£¼ì˜**: `.env.local` íŒŒì¼ì€ ì ˆëŒ€ Gitì— ì»¤ë°‹í•˜ì§€ ë§ˆì„¸ìš”!

---

## 2. Supabase ì„¤ì •

### 2.1. ë°ì´í„°ë² ì´ìŠ¤ ì„¤ì •

1. Supabase ì½˜ì†”ì—ì„œ **SQL Editor** ë©”ë‰´ë¡œ ì´ë™
2. **New query** ë²„íŠ¼ í´ë¦­
3. `supabase/schema.sql` íŒŒì¼ ë‚´ìš© ë³µì‚¬ & ë¶™ì—¬ë„£ê¸°
4. **Run** ë²„íŠ¼ í´ë¦­

ìƒì„±ë˜ëŠ” í…Œì´ë¸”:
- âœ… `user_profiles` - ì‚¬ìš©ì í”„ë¡œí•„ ë° ê²Œì„ ì§„í–‰ ìƒíƒœ
- âœ… `toss_login_logs` - í† ìŠ¤ ë¡œê·¸ì¸ ê¸°ë¡

### 2.2. ì´ë©”ì¼ í™•ì¸ ë¹„í™œì„±í™” (ì¤‘ìš”!)

**Authentication** â†’ **Providers** â†’ **Email** â†’ **Confirm email** â†’ **OFF**

âš ï¸ ì´ ì„¤ì •ì„ í•˜ì§€ ì•Šìœ¼ë©´ í† ìŠ¤ ë¡œê·¸ì¸ ì‹œ ì´ë©”ì¼ ê²€ì¦ ì—ëŸ¬ê°€ ë°œìƒí•©ë‹ˆë‹¤!

### 2.3. Row Level Security í™•ì¸

**Authentication** > **Policies** ë©”ë‰´ì—ì„œ ë‹¤ìŒ ì •ì±…ì´ í™œì„±í™”ë˜ì—ˆëŠ”ì§€ í™•ì¸:

- `Users can view own profile`
- `Users can update own profile`
- `Users can insert own profile`

---

## 3. Supabase Edge Function ë°°í¬

### 3.1. Supabase CLI ì„¤ì¹˜

**Windows (Scoop)**:
```powershell
scoop bucket add supabase https://github.com/supabase/scoop-bucket.git
scoop install supabase
```

**macOS (Homebrew)**:
```bash
brew install supabase/tap/supabase
```

### 3.2. Supabase ë¡œê·¸ì¸

```powershell
supabase login
```

### 3.3. í”„ë¡œì íŠ¸ ì—°ê²°

```powershell
supabase link --project-ref your-project-ref
```

í”„ë¡œì íŠ¸ refëŠ” Supabase URLì—ì„œ í™•ì¸: `https://[your-project-ref].supabase.co`

### 3.4. mTLS ì¸ì¦ì„œ ì¸ì½”ë”©

ì•±ì¸í† ìŠ¤ ì½˜ì†”ì—ì„œ ë°œê¸‰ë°›ì€ ì¸ì¦ì„œë¥¼ `backend/certs/` í´ë”ì— ì €ì¥ í›„:

```powershell
cd supabase/functions/scripts
.\encode-certs.ps1
```

ì¶œë ¥ëœ ëª…ë ¹ì–´ 2ê°œë¥¼ ì‹¤í–‰í•˜ì—¬ Secrets ì €ì¥:

```powershell
supabase secrets set TOSS_CERT_BASE64="..."
supabase secrets set TOSS_KEY_BASE64="..."
```

### 3.5. Edge Function ë°°í¬

```powershell
supabase functions deploy toss-auth
```

ë°°í¬ ì„±ê³µ ì‹œ ë‹¤ìŒ URLì´ ìƒì„±ë©ë‹ˆë‹¤:
```
https://[your-project-ref].supabase.co/functions/v1/toss-auth
```

---

## 4. ë¡œì»¬ ê°œë°œ í…ŒìŠ¤íŠ¸

### ê°œë°œ ì„œë²„ ì‹¤í–‰

```bash
npm run dev
```

ë¸Œë¼ìš°ì €ì—ì„œ `http://localhost:5173` ì ‘ì†

### í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤

1. **ë©”ì¸ í˜ì´ì§€ í™•ì¸**
   - "í† ìŠ¤ë¡œ ì‹œì‘í•˜ê¸°" ë²„íŠ¼ í‘œì‹œ í™•ì¸
   - ê°œë°œ í™˜ê²½ ì•ˆë‚´ ë©”ì‹œì§€ í™•ì¸ (ë…¸ë€ìƒ‰ ë°•ìŠ¤)
   - **Eruda ë””ë²„ê¹… ë„êµ¬** ìš°ì¸¡ í•˜ë‹¨ ë²„íŠ¼ í™•ì¸

2. **Eruda ì½˜ì†” í™•ì¸**
   - ìš°ì¸¡ í•˜ë‹¨ ì´ˆë¡ìƒ‰ ë²„íŠ¼ í´ë¦­
   - Console íƒ­ì—ì„œ ë¡œê·¸ í™•ì¸
   - Resources íƒ­ì—ì„œ í™˜ê²½ ë³€ìˆ˜ ë¡œë“œ í™•ì¸

3. **ë¡œê·¸ì¸ í”Œë¡œìš° (ì•±ì¸í† ìŠ¤ í™˜ê²½ì—ì„œë§Œ)**
   - ë¡œê·¸ì¸ ë²„íŠ¼ í´ë¦­
   - í† ìŠ¤ ë¡œê·¸ì¸ í™”ë©´ í‘œì‹œ
   - ë¡œê·¸ì¸ ì™„ë£Œ í›„ `/game` í˜ì´ì§€ë¡œ ì´ë™

âš ï¸ **ì°¸ê³ **: ë¡œì»¬ í™˜ê²½ì—ì„œëŠ” `appLogin()` í•¨ìˆ˜ê°€ ì—†ì–´ ì‹¤ì œ ë¡œê·¸ì¸ì´ ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤. ìƒŒë“œë°•ìŠ¤ ì•±ì—ì„œ í…ŒìŠ¤íŠ¸í•´ì•¼ í•©ë‹ˆë‹¤.

---

## 4. ìƒŒë“œë°•ìŠ¤ ì•± í…ŒìŠ¤íŠ¸

### .ait íŒŒì¼ ë¹Œë“œ

```bash
npm run build
```

ë¹Œë“œ ì„±ê³µ ì‹œ `health-hero.ait` íŒŒì¼ì´ ìƒì„±ë©ë‹ˆë‹¤.

### ì•±ì¸í† ìŠ¤ ìƒŒë“œë°•ìŠ¤ì—ì„œ í…ŒìŠ¤íŠ¸

1. [ì•±ì¸í† ìŠ¤ ì½˜ì†”](https://developers-apps-in-toss.toss.im) > **ì¶œì‹œí•˜ê¸°** ë©”ë‰´
2. **í…ŒìŠ¤íŠ¸** íƒ­ ì„ íƒ
3. `.ait` íŒŒì¼ ì—…ë¡œë“œ
4. QR ì½”ë“œ ìŠ¤ìº”í•˜ì—¬ ìƒŒë“œë°•ìŠ¤ ì•± ì‹¤í–‰

### ìƒŒë“œë°•ìŠ¤ ì•±ì—ì„œ í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤

1. **ì•± ì‹¤í–‰**
   - ë©”ì¸ í™”ë©´ì— "í† ìŠ¤ë¡œ ì‹œì‘í•˜ê¸°" ë²„íŠ¼ í™•ì¸
   - **Eruda ë””ë²„ê¹… ë„êµ¬** ìš°ì¸¡ í•˜ë‹¨ í™•ì¸

2. **Eruda ì½˜ì†” ì—´ê¸°**
   - ìš°ì¸¡ í•˜ë‹¨ ì´ˆë¡ìƒ‰ ë²„íŠ¼ í´ë¦­
   - Console íƒ­ ì¤€ë¹„
   - Network íƒ­ ì¤€ë¹„

3. **í† ìŠ¤ ë¡œê·¸ì¸**
   - ë²„íŠ¼ í´ë¦­ ì‹œ í† ìŠ¤ ë¡œê·¸ì¸ í™”ë©´ í‘œì‹œ
   - í…ŒìŠ¤íŠ¸ ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸
   - ì´ë¦„ ì •ë³´ ì œê³µ ë™ì˜

4. **ë¡œê·¸ì¸ ì„±ê³µ í™•ì¸**
   - ê²Œì„ í˜ì´ì§€(`/game`)ë¡œ ìë™ ì´ë™
   - **Eruda Console**ì—ì„œ ë¡œê·¸ í™•ì¸:
     ```
     ğŸš€ [TossLogin] ë¡œê·¸ì¸ ì‹œì‘
     âœ… [TossLogin] í† ìŠ¤ ë¡œê·¸ì¸ ì„±ê³µ
     âœ… [TossLogin] Supabase ì—°ë™ ì„±ê³µ
     ğŸ® [TossLogin] ê²Œì„ í˜ì´ì§€ë¡œ ì´ë™
     ```
   - **Eruda Network**ì—ì„œ API í˜¸ì¶œ í™•ì¸
   - **Eruda Resources**ì—ì„œ í† í° ì €ì¥ í™•ì¸

5. **Supabase ë°ì´í„° í™•ì¸**
   - Supabase > **Table Editor** > `user_profiles`
   - ìƒˆë¡œìš´ ì‚¬ìš©ì ë ˆì½”ë“œ ìƒì„± í™•ì¸
   - `toss_user_key`, `name` í•„ë“œ í™•ì¸

---

## 5. íŠ¸ëŸ¬ë¸”ìŠˆíŒ…

### "ì•±ì¸í† ìŠ¤ í™˜ê²½ì—ì„œë§Œ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤" ì—ëŸ¬

**ì›ì¸**: ë¡œì»¬ í™˜ê²½ì´ë‚˜ ì¼ë°˜ ë¸Œë¼ìš°ì €ì—ì„œ ì‹¤í–‰ ì¤‘

**í•´ê²°**:
- ìƒŒë“œë°•ìŠ¤ ì•± ë˜ëŠ” í† ìŠ¤ì•±ì—ì„œ í…ŒìŠ¤íŠ¸
- `.ait` íŒŒì¼ì„ ë¹Œë“œí•˜ì—¬ ì—…ë¡œë“œ

### "Missing Supabase environment variables" ì—ëŸ¬

**ì›ì¸**: í™˜ê²½ ë³€ìˆ˜ê°€ ì„¤ì •ë˜ì§€ ì•ŠìŒ

**í•´ê²°**:
1. `.env.local` íŒŒì¼ì´ í”„ë¡œì íŠ¸ ë£¨íŠ¸ì— ìˆëŠ”ì§€ í™•ì¸
2. í™˜ê²½ ë³€ìˆ˜ ê°’ì´ ì˜¬ë°”ë¥¸ì§€ í™•ì¸
3. ê°œë°œ ì„œë²„ ì¬ì‹œì‘ (`npm run dev`)

### í† í° ë°œê¸‰ ì‹¤íŒ¨ (401, 403 ì—ëŸ¬)

**ì›ì¸**: Client ID ë˜ëŠ” Client Secretì´ ì˜ëª»ë¨

**í•´ê²°**:
1. ì•±ì¸í† ìŠ¤ ì½˜ì†”ì—ì„œ Client ID, Secret ì¬í™•ì¸
2. `.env.local` íŒŒì¼ì˜ ê°’ ì—…ë°ì´íŠ¸
3. ê°œë°œ ì„œë²„ ì¬ì‹œì‘

### ì‚¬ìš©ì í”„ë¡œí•„ ìƒì„± ì‹¤íŒ¨

**ì›ì¸**: Supabase RLS ì •ì±… ë˜ëŠ” í…Œì´ë¸” ì„¤ì • ë¬¸ì œ

**í•´ê²°**:
1. Supabase > **Table Editor**ì—ì„œ `user_profiles` í…Œì´ë¸” í™•ì¸
2. **Authentication** > **Policies**ì—ì„œ ì •ì±… í™œì„±í™” í™•ì¸
3. SQL ìŠ¤í¬ë¦½íŠ¸ ì¬ì‹¤í–‰

### "User already registered" ì—ëŸ¬

**ì›ì¸**: ë™ì¼í•œ í† ìŠ¤ ê³„ì •ìœ¼ë¡œ ì´ë¯¸ ê°€ì…ë¨

**í•´ê²°**:
- ì •ìƒì ì¸ ë™ì‘ì…ë‹ˆë‹¤
- ê¸°ì¡´ ì‚¬ìš©ìë¡œ ë¡œê·¸ì¸ë©ë‹ˆë‹¤
- Supabaseì—ì„œ ì‚¬ìš©ì ì •ë³´ê°€ ì—…ë°ì´íŠ¸ë©ë‹ˆë‹¤

---

## ğŸ‰ ì„¤ì • ì™„ë£Œ!

ëª¨ë“  ì„¤ì •ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ì´ì œ í† ìŠ¤ ë¡œê·¸ì¸ì„ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

### âœ… êµ¬í˜„ í™•ì¸

**ì„œë²„ë¦¬ìŠ¤ ì•„í‚¤í…ì²˜:**
- Client Secret ë¶ˆí•„ìš” (í† ìŠ¤ API ì„¤ê³„)
- mTLS ë¶ˆí•„ìš” (ê¸°ë³¸ ë¡œê·¸ì¸)
- ë°±ì—”ë“œ ì„œë²„ ë¶ˆí•„ìš” (Supabaseë§Œìœ¼ë¡œ ì™„ê²°)

**ë¹„ìš©:**
- Supabase Free Tier: $0/ì›”
- Vercel í˜¸ìŠ¤íŒ…: $0/ì›”
- ì´í•©: **$0/ì›”** ğŸ‰

### ë‹¤ìŒ ë‹¨ê³„

1. **ê²Œì„ ë¡œì§ êµ¬í˜„**: í€´ì¦ˆ ì‹œìŠ¤í…œ ë° ê²Œì„ í”Œë¡œìš°
2. **ì‚¬ìš©ì í”„ë¡œí•„ UI**: ë ˆë²¨, ê²½í—˜ì¹˜, ì ìˆ˜ í‘œì‹œ
3. **í† í° ìë™ ê°±ì‹ **: ë°±ê·¸ë¼ìš´ë“œì—ì„œ í† í° ê°±ì‹ 
4. **ì—ëŸ¬ ì²˜ë¦¬ ê³ ë„í™”**: ë” ì¹œí™”ì ì¸ ì—ëŸ¬ ë©”ì‹œì§€

### ì°¸ê³  ë¬¸ì„œ

- [Toss.md](./Toss.md) - ìƒì„¸í•œ í† ìŠ¤ ë¡œê·¸ì¸ ê°€ì´ë“œ
- [ì•±ì¸í† ìŠ¤ ê³µì‹ ë¬¸ì„œ](https://developers-apps-in-toss.toss.im/)
- [Supabase ê³µì‹ ë¬¸ì„œ](https://supabase.com/docs)

---

## ğŸ”§ ì¸ì¦ ì‹œìŠ¤í…œ ê°œì„  (2025-01-30)

### ìë™ ì—ëŸ¬ ë³µêµ¬

`TossAuthService`ê°€ ë‹¤ì–‘í•œ ì¸ì¦ ì—ëŸ¬ë¥¼ ìë™ìœ¼ë¡œ ì²˜ë¦¬í•©ë‹ˆë‹¤:

#### 1. user_already_exists ì—ëŸ¬ ìë™ ì²˜ë¦¬

```typescript
if (signUpError.message.includes('already')) {
  // ê¸°ì¡´ Auth ì‚¬ìš©ìë¡œ ìë™ signIn ì‹œë„
  const { data: signInData } = await supabase.auth.signInWithPassword({
    email,
    password
  })
  userId = signInData.user.id
}
```

#### 2. auth.users/user_profiles ë¶ˆì¼ì¹˜ ìë™ ë³µêµ¬

```typescript
if (signInError.message.includes('Invalid') || signInError.message.includes('credentials')) {
  // auth.users ì—†ê³  user_profilesë§Œ ë‚¨ì€ ê²½ìš°
  // 1. ê¸°ì¡´ í”„ë¡œí•„ ì‚­ì œ
  await supabase.from('user_profiles').delete().eq('id', existingProfile.id)
  // ê´€ë ¨ ë°ì´í„°ë„ í•¨ê»˜ ì‚­ì œ
  
  // 2. ìƒˆë¡œìš´ Auth ì‚¬ìš©ì ìƒì„±
  const { data: signUpData } = await supabase.auth.signUp({ ... })
}
```

#### 3. ë¹„ë°€ë²ˆí˜¸ ì¼ê´€ì„± í™•ë³´

```typescript
// ê³ ì • ë¹„ë°€ë²ˆí˜¸ ì‚¬ìš©ìœ¼ë¡œ ì¼ê´€ì„± í™•ë³´
const password = `toss_${user.userKey}_permanent`
```

### ì¸ì¦ ìƒíƒœë³„ ìë™ ì²˜ë¦¬

| auth.users | user_profiles | ìë™ ì²˜ë¦¬ |
|------------|---------------|-----------|
| âœ… ìˆìŒ | âœ… ìˆìŒ | ê¸°ì¡´ ì„¸ì…˜ìœ¼ë¡œ ë¡œê·¸ì¸ |
| âŒ ì—†ìŒ | âœ… ìˆìŒ | í”„ë¡œí•„ ì‚­ì œ â†’ ì‹ ê·œ ìƒì„± |
| âœ… ìˆìŒ | âŒ ì—†ìŒ | signIn â†’ í”„ë¡œí•„ ìƒì„± |
| âŒ ì—†ìŒ | âŒ ì—†ìŒ | ì™„ì „ ì‹ ê·œ ì‚¬ìš©ì ìƒì„± |

### ê°œë°œìë¥¼ ìœ„í•œ íŒ

ê°œë°œ ì¤‘ í…ŒìŠ¤íŠ¸ ë°ì´í„°ë¥¼ ì™„ì „íˆ ì‚­ì œí•˜ë ¤ë©´ `TROUBLESHOOTING.md`ì˜ "í…ŒìŠ¤íŠ¸ ë°ì´í„° ì™„ì „ ì‚­ì œ" ì„¹ì…˜ì„ ì°¸ê³ í•˜ì„¸ìš”.

---

**Last Updated**: 2025-01-30  
**Version**: 1.1.0  
**Status**: âœ… ì¸ì¦ ì‹œìŠ¤í…œ ìë™ ë³µêµ¬ ì™„ë£Œ

