# 🚀 헬스 히어로 구현 현황

**최종 업데이트**: 2025-01-27 (최신)  
**현재 단계**: Phase 4 완료 + 고급 시스템 구현 완료 (페이즈 잠금, 레벨업, 중복 방지)

---

## 📊 전체 진행률

- **Phase 1**: 프로젝트 설정 및 기본 구조 ✅ **100%**
- **Phase 2**: DB 스키마 & 데이터 임포트 ✅ **100%**
- **Phase 3-1**: 메인 게임 페이지 UI 구현 ✅ **100%**
- **Phase 3-2**: 실제 데이터 연동 및 최적화 ✅ **100%**
- **Phase 3-3**: 스테이지 페이지 시스템 구현 ✅ **100%**
- **Phase 4**: 퀴즈 게임 메커니즘 구현 ✅ **100%** (완료)
- **Phase 4.5**: 하트 부족 모달 시스템 ✅ **100%** (완료)
- **Phase 4.6**: 페이즈별 스테이지 잠금 시스템 ✅ **100%** (완료)
- **Phase 4.7**: 레벨업 시스템 완전 구현 ✅ **100%** (완료)
- **Phase 4.8**: 문제 중복 방지 및 난이도 분배 ✅ **100%** (완료)

---

## ✅ 완료된 기능 (2025-01-27 최신)

### 10. 퀴즈 게임 메커니즘 구현 (2025-01-27 완료)

### 11. 점수/경험치 시스템 구현 (2025-01-27 완료)

#### 11.1. 난이도별 점수/경험치 계산

- **쉬움 (1-2스테이지)**: 10점, 12XP
- **보통 (3-4스테이지)**: 30점, 18XP
- **어려움 (5스테이지)**: 50점, 26XP

#### 11.2. 스테이지 완료 보너스

- **5정답**: +50점, +100XP
- **4정답**: +30점, +60XP
- **3정답**: +25XP
- **2이하**: 보너스 없음

#### 11.3. 사용자 답안 추적 시스템

- 모든 답안을 배열로 저장
- 정답 개수 실시간 계산
- 스테이지 성공/실패 판정 (3문제 이상 정답 시 성공)

### 12. 레벨업 시스템 구현 (2025-01-27 완료)

#### 12.1. 레벨업 필요 XP 공식

- **공식**: `XP_to_next(L) = round(120 × 1.15^(L-1))`
- **최대 레벨**: 20레벨 (헬스 히어로)
- **총 필요 XP**: 약 10,609 XP

#### 12.2. 레벨별 직급 시스템

- **Lv.1**: 의대 새내기
- **Lv.5**: 인턴
- **Lv.10**: 레지던트
- **Lv.15**: 전문의
- **Lv.20**: 헬스 히어로

#### 12.3. 레벨업 보상 시스템

- **매 레벨 하트 +1 즉시 회복** (최대치 초과 불가)
- 레벨업 시 콘솔 로그로 알림
- 다중 레벨업 지원 (한 번에 여러 레벨 상승 가능)

### 13. 스테이지 결과 모달 시스템 (2025-01-27 완료)

#### 13.1. 모달 UI 구현

- **성공 모달**: `popup-success.png` 배경 (324x440px)
- **실패 모달**: `popup-failed.png` 배경 (324x440px)
- **제목**: "스테이지 성공!" / "스테이지 실패!" (32px, weight 400)
- **배경 효과**: 블러 처리로 자연스러운 전환

#### 13.2. 보상 표시 시스템

- **보상 박스**: 70x70px 베이지색 박스 (#B97951)
- **경험치 아이콘**: `icon-exp.png` (40x40px)
- **점수 아이콘**: `icon-star.png` (40x40px)
- **텍스트**: "+[값]" 형식 (14px, weight 400)

#### 13.3. 네비게이션 시스템

- **보상 받기 버튼**: 160x56px 파란색 그라데이션
- **페이즈별 라우팅**: 현재 페이즈에 따라 해당 페이즈 페이지로 이동
  - 1페이즈 완료 → `/game/phase1`
  - 2페이즈 완료 → `/game/phase2`
  - 3페이즈 완료 → `/game/phase3`
  - 4페이즈 완료 → `/game/phase4`

### 14. 데이터베이스 연동 시스템 (2025-01-27 완료)

#### 14.1. Supabase RPC 함수

- **`update_user_progress`**: 점수/경험치/레벨 업데이트
- **`complete_stage`**: 스테이지 완료 처리 및 다음 스테이지 잠금 해제
- **`consume_heart`**: 하트 소모 (스테이지 진입, 오답 시)
- **`refill_heart`**: 하트 충전 (레벨업 보상)

#### 14.2. 게임 스토어 연동

- **`addScoreAndExp`**: 점수/경험치 추가 및 레벨업 체크
- **`completeStage`**: 스테이지 완료 처리
- **`checkLevelUp`**: 레벨업 조건 확인
- **`getLevelInfo`**: 레벨 정보 조회

#### 14.3. 실시간 데이터 동기화

- 점수/경험치 변경 시 즉시 데이터베이스 업데이트
- 레벨업 시 하트 자동 회복
- 스테이지 진행 상황 실시간 저장

### 15. 하트 부족 모달 시스템 (2025-01-27 완료)

#### 15.1. 하트 부족 감지 로직

- **스테이지 진입 시**: 하트가 0개일 때 모달 표시
- **오답 시**: 하트 차감 후 하트가 0이 되면 모달 표시
- **실시간 체크**: 하트 상태 변화 감지 및 즉시 모달 표시

#### 15.2. 모달 UI 구현

- **칠판 배경**: `blackboard.png` (342x282px) 사용
- **배경 효과**: 블러 처리로 자연스러운 전환 (`backdrop-blur-md`)
- **텍스트**: "이런, 퀴즈를 풀기 위한 하트가 부족해요!" (18px)
- **하트 표시**: `icon-heart.png` (100x100px) 중앙에 "0" 텍스트
- **타이머 영역**: `icon-timer.png` + `block01.png` 조합으로 충전 시간 표시

#### 15.3. 버튼 시스템

- **500 포인트 버튼**: 별 아이콘 + "500" 텍스트 (140x56px)
- **나가기 버튼**: 포인트 부족 시 표시 (빨간색, 140x56px)
- **광고 버튼**: 플레이 아이콘 + "하트 받기" 텍스트 (140x56px)
- **조건부 표시**: 포인트 보유량에 따라 다른 버튼 표시

#### 15.4. 기능 구현

- **500 포인트 구매**: `buyHeartWithPoints()` 함수 사용
- **나가기**: 현재 페이즈 페이지로 이동 (`/game/phase${currentPhase}`)
- **광고 버튼**: 콘솔 로그 출력 ("광고 버튼 클릭.")

#### 15.5. 데이터베이스 연동

- **RPC 함수**: `buy_heart_with_points` 함수 사용
- **에러 해결**: ambiguous column reference 문제 수정
- **실시간 업데이트**: 하트 구매 후 즉시 UI 반영

### 16. 네비게이션 시스템 개선 (2025-01-27 완료)

#### 16.1. 뒤로가기 버튼 통일

- **모든 Phase 페이지**: `router.back()` → `router.push('/game')`로 변경
- **일관된 경험**: 어떤 Phase에서든 메인 게임 페이지로 직접 이동
- **적용 범위**: Phase 1, 2, 3, 4 모든 페이지

#### 16.2. 라우팅 최적화

- **명확한 네비게이션**: 브라우저 히스토리 대신 직접 라우팅
- **사용자 경험**: 예측 가능한 네비게이션 동작
- **일관성**: 모든 Phase 페이지에서 동일한 동작

- **페이지 구조**: `/game/quiz?phase=1&stage=1` 동적 라우팅
- **배경 시스템**: 정답/오답에 따른 동적 배경 변경
  - 퀴즈 중: `/images/backgrounds/background-quiz.png`
  - 정답: `/images/backgrounds/background-answer.png`
  - 오답: `/images/backgrounds/background-wrong.png`

#### 10.2. 퀴즈 문제 표시 시스템

- **칠판 UI**: 342x282px 칠판 이미지 (`/images/items/blackboard.png`)
- **동적 폰트**: 텍스트 길이에 따른 자동 폰트 크기 조정
  - 20자 이하: text-2xl (24px)
  - 30자 이하: text-xl (20px)
  - 40자 이하: text-lg (18px)
  - 50자 이하: text-base (16px)
  - 60자 이하: text-sm (14px)
  - 60자 초과: text-xs (12px)
- **문제 구성**: 토픽 + 문제 텍스트 조합

#### 10.3. 선택지 버튼 시스템

- **버튼 사양**: 300x56px 파란색 그라데이션 버튼
- **스타일**:
  - 배경: `linear-gradient(180deg, #50B0FF 0%, #50B0FF 50%, #008DFF 50%, #008DFF 100%)`
  - 테두리: `2px solid #76C1FF`
  - 외곽선: `2px solid #000000`
  - 그림자: `0px 4px 4px 0px rgba(0, 0, 0, 0.25), inset 0px 3px 0px 0px rgba(0, 0, 0, 0.1)`
- **텍스트**: 흰색 16px, weight 400, 1px 검은색 스트로크
- **포인트 이미지**: `/images/items/button-point-blue.png` (8.47x6.3px)

#### 10.4. 진행률 표시 시스템

- **프로그래스바**: 상단 고정 위치 (`top-[84px]`)
- **구성 요소**:
  - 테두리: `/images/ui/progressbar01.png` (310x24px)
  - 내부: `/images/ui/progressbar02.png` (300x16px)
  - 진행률: 녹색 그라데이션 바
- **텍스트**: "STAGE 1-1 (1/5)" 형식으로 현재 진행 상황 표시

#### 10.5. 결과 페이지 시스템

- **정답 페이지**:
  - 배경: `/images/backgrounds/background-answer.png`
  - 메시지: "정답입니다!"
  - 설명: 퀴즈 테이블의 explanation 필드 표시
- **오답 페이지**:
  - 배경: `/images/backgrounds/background-wrong.png`
  - 메시지: "아쉽네요! 정답은,"
  - 정답 표시: 정답 선택지 + 설명
- **다음 문제 버튼**: 160x56px, 선택지 버튼과 동일한 스타일
- **선택한 답안 표시**:
  - 정답: 녹색 그라데이션 (#00C951)
  - 오답: 빨간색 그라데이션 (#FF2F32)

#### 10.6. 아이템 바 시스템

- **위치**: 화면 하단 고정 (`fixed bottom-0`)
- **z-index**: 50 (선택지 버튼보다 위에 표시)
- **아이템 구성**: 4개 아이템 버튼 (60x60px, 20px 간격)
  - 오답 삭제: 50포인트 이상 필요
  - 힌트: 80포인트 이상 필요
  - 점수 2배: 100포인트 이상 필요
  - 자동 정답: 200포인트 이상 필요
- **상태 표시**: 포인트 부족 시 disable 이미지 표시

#### 10.7. 하트 시스템 구현

- **스테이지 진입 시 하트 차감**: 진입 시 1개 하트 소모
- **오답 시 하트 차감**: 틀린 답 선택 시 1개 하트 소모
- **중복 차감 방지**: `useRef`를 사용한 중복 실행 방지 메커니즘
- **실시간 카운트다운**: 5분마다 하트 충전, 실시간 카운트다운 표시
- **하트 부족 처리**: 하트가 0일 때 스테이지 진입 불가

#### 10.8. 랜덤 퀴즈 시스템

- **난이도별 문제**: 스테이지별 난이도 매핑
  - 스테이지 1-2: 쉬움
  - 스테이지 3-4: 보통
  - 스테이지 5: 어려움
- **중복 방지**: 스테이지당 5개 문제를 중복 없이 랜덤 선택
- **클라이언트 사이드 셔플링**: Supabase 제한으로 인한 클라이언트 사이드 랜덤 처리

#### 10.9. 데이터베이스 연동

- **퀴즈 데이터**: `quizzes` 테이블에서 문제 로드
- **사용자 진행**: `user_profiles` 테이블에서 현재 스테이지 정보
- **하트 관리**: `user_hearts` 테이블에서 실시간 하트 상태
- **RPC 함수**: `consume_heart` 함수로 하트 차감 처리

#### 10.10. 에러 처리 및 최적화

- **Supabase 에러 해결**: `consume_heart` RPC 함수의 ambiguous column reference 수정
- **Phaser 제거**: SSR 호환성을 위해 Phaser 폭죽 애니메이션 제거
- **디버깅 로그 정리**: 프로덕션 환경에 적합한 코드로 정리
- **상태 관리 최적화**: Zustand 스토어의 효율적인 상태 업데이트

## ✅ 완료된 기능 (2025-10-21 이전)

### 5. 스테이지 페이지 시스템 (2025-10-21 최신 완료)

#### 5.1. 페이즈별 스테이지 페이지 구현

- **페이지 구조**: `/game/phase1`, `/game/phase2`, `/game/phase3`, `/game/phase4`
- **페이즈별 고유 배경**: 각 페이즈마다 다른 배경 이미지 적용
  - Phase 1: `/images/backgrounds/background-phase1.png`
  - Phase 2: `/images/backgrounds/background-phase2.png`
  - Phase 3: `/images/backgrounds/background-phase3.png`
  - Phase 4: `/images/backgrounds/background-phase4.png`

#### 5.2. 스테이지 버튼 시스템

- **버튼 사양**: 64x64px 파란색 그라데이션 버튼
- **스타일**:
  - 배경: `linear-gradient(180deg, #50B0FF 0%, #50B0FF 50%, #008DFF 50%, #008DFF 100%)`
  - 테두리: `2px solid #76C1FF`
  - 외곽선: `2px solid #000000`
  - 그림자: `0px 4px 4px 0px rgba(0, 0, 0, 0.25), inset 0px 3px 0px 0px rgba(0, 0, 0, 0.1)`
- **텍스트**: 흰색 18px, weight 400, 1px 검은색 스트로크
- **포인트 이미지**: `/images/items/button-point-blue.png` (8.47x6.3px)

#### 5.3. 스테이지 배치 시스템

- **세로 배치**: 5개 스테이지 버튼을 세로로 배치
- **위치**: 화면 중앙을 기준으로 절대 위치 지정
- **간격**: 스테이지 간 적절한 간격으로 배치

#### 5.4. 뒤로가기 버튼

- **위치**: 좌측 상단 (`top-4 left-4`)
- **이미지**: `/images/items/icon-backspace.png` (24x24px)
- **기능**: `router.back()`으로 이전 페이지로 이동

### 6. 스테이지 잠금 시스템 (2025-10-21 최신 완료)

#### 6.1. 실제 데이터 기반 잠금

- **데이터 필드**: `gameStore`에 `currentStage` 필드 추가
- **잠금 로직**: `stageNumber > currentStage`일 때 잠금
- **데이터베이스**: `user_profiles` 테이블의 `current_stage` 필드 활용

#### 6.2. 잠금 상태 표시

- **잠금 아이콘**: `/images/items/icon-lock.png` (24x24px)
- **클릭 방지**: 잠금된 스테이지는 클릭 불가 (`cursor-not-allowed`)
- **시각적 구분**: 잠금 상태와 활성 상태 명확한 구분

### 7. 반응형 스크롤 시스템 (2025-10-21 최신 완료)

#### 7.1. 화면 크기 감지

- **기준**: `window.innerHeight < 700px`를 작은 화면으로 판단
- **실시간 감지**: `resize` 이벤트 리스너로 화면 크기 변경 감지
- **상태 관리**: `useState`로 `isSmallScreen` 상태 관리

#### 7.2. 조건부 스크롤 설정

- **작은 화면**: `overflow-y-auto`로 스크롤 활성화
- **일반 화면**: `overflow-hidden`으로 스크롤 비활성화
- **높이 설정**: 작은 화면 `calc(100vh + 40px)`, 일반 화면 `90vh`

#### 7.3. 반응형 스테이지 배치

- **작은 화면**: 조밀한 스테이지 버튼 배치
- **일반 화면**: 여유로운 스테이지 버튼 배치
- **일관된 경험**: 메인 페이지와 모든 페이즈 페이지에 동일 적용

### 8. 로딩 화면 개선 (2025-10-21 최신 완료)

#### 8.1. 배경 이미지 사용

- **기존**: 검정색 배경 사용
- **개선**: 각 페이지의 실제 배경 이미지 사용
- **적용 범위**: 메인 페이지와 모든 페이즈 페이지

#### 8.2. 일관된 사용자 경험

- **로딩 중**: 페이지 테마 유지
- **에러 상태**: 동일한 배경 이미지 사용
- **텍스트**: 중앙 정렬된 로딩/에러 메시지

### 9. UI/UX 최적화 (2025-10-21 최신 완료)

#### 9.1. 투명 처리 제거

- **스테이지 버튼**: 잠금 상태에서 `opacity-60` 제거
- **페이즈 블록**: 잠금 상태에서 추가 블러 효과 제거
- **명확한 구분**: 잠금 상태와 활성 상태 명확한 시각적 구분

#### 9.2. 컴포넌트 최적화

- **StageButton 컴포넌트**: 재사용 가능한 스테이지 버튼 컴포넌트
- **조건부 렌더링**: 잠금 상태에 따른 아이콘/텍스트 표시
- **이벤트 처리**: 잠금 상태에서 클릭 이벤트 방지

---

## ✅ 완료된 기능 (2025-10-21 이전)

### 1. 메인 게임 페이지 헤더

#### 1.1. 고정 헤더 구현

- **위치**: 화면 상단 고정
- **사양**: 상단 12px 여백, 높이 60px, 좌우 24px 패딩
- **내부 간격**: 요소 간 20px 간격

#### 1.2. 캐릭터 & 레벨 시스템

- **구현**: 레벨별 동적 캐릭터 이미지 로딩
- **이미지**:
  - 원형 블록 (40x40px): `/images/ui/block02.png`
  - 캐릭터 이미지 (30x30px): 레벨별 동적 로딩
  - 레벨 블록 (70x24px): `/images/ui/block01.png`
- **레벨별 캐릭터**:
  - Lv.1: `/images/characters/level-1.png`
  - Lv.5: `/images/characters/level-5.png`
  - Lv.10: `/images/characters/level-10.png`
  - Lv.15: `/images/characters/level-15.png`
  - Lv.20: `/images/characters/level-20.png`

#### 1.3. 하트 시스템

- **구현**: 실시간 하트 개수 및 충전 타이머 표시
- **이미지**:
  - 하트 아이콘 (44x44px): `/images/items/icon-heart.png`
  - 광고 버튼 (16x16px): `/images/items/button-ad.png`
  - 타이머 블록 (70x24px): `/images/ui/block01.png`
- **로직**:
  - 하트 5개: "충전 완료" 표시
  - 하트 4개 이하: 실시간 카운트다운 (예: "4분12초")
- **최적화**: `refill_heart` 불필요한 호출 97% 감소

#### 1.4. 점수 시스템

- **구현**: 현재 보유 포인트 표시
- **이미지**:
  - 별 아이콘 (40x40px): `/images/items/Icon-star.png`
  - 점수 블록 (70x24px): `/images/ui/block01.png`
- **초기값**: 최초 회원가입 시 500포인트 지급

#### 1.5. 설정 버튼

- **구현**: 설정 메뉴 접근 버튼
- **이미지**: 설정 아이콘 (24x24px): `/images/items/button-setting.png`
- **효과**: 호버 시 투명도 변경

### 2. 페이즈 맵 시스템

#### 2.1. 페이즈 블록 구현

- **개수**: 4개 페이즈 블록
- **사양**: 블러 처리된 투명 카드 (150x160px)
- **스타일**:
  - 배경: `bg-white/50 backdrop-blur-[10px]`
  - 그림자: `shadow-[0_2px_2px_0_rgba(0,0,0,0.4)]`
  - 모서리: `rounded-[20px]`

#### 2.2. 상태별 이미지 표시

- **활성화 상태**: 페이즈별 아이콘 (120x120px)
  - 페이즈 1: `/images/items/icon-phase1.png`
  - 페이즈 2: `/images/items/icon-phase2.png`
  - 페이즈 3: `/images/items/icon-phase3.png`
  - 페이즈 4: `/images/items/icon-phase4.png`
- **잠금 상태**: 잠금 아이콘 (120x120px)
  - 이미지: `/images/items/icon-locked-phase.png`

#### 2.3. 페이즈 배치

- **페이즈 1**: 화면 하단으로부터 20px, 우측으로부터 24px
- **페이즈 2**: 페이즈 1보다 위, 좌측으로부터 24px
- **페이즈 3**: 페이즈 2보다 위, 우측으로부터 24px
- **페이즈 4**: 페이즈 3보다 위, 좌측으로부터 24px

#### 2.4. 연결선 구현

- **페이즈 1 → 2**: `/images/ui/vector1.png` (170x60px)
- **페이즈 2 → 3**: `/images/ui/vector2.png` (170x60px)
- **페이즈 3 → 4**: `/images/ui/vector1.png` (170x60px)
- **레이어링**: 페이즈 요소보다 뒤에 배치 (`z-0`)
- **투명도**: `opacity-80`

### 3. 스크롤 및 네비게이션

#### 3.1. 스크롤 기능

- **스크롤 영역**: 메인 콘텐츠 영역 (`overflow-y-auto`)
- **고정 헤더**: 상단 헤더는 고정, 콘텐츠만 스크롤
- **높이 설정**: `calc(100vh + 0px)`로 스크롤 가능 영역 확보

#### 3.2. 초기 위치 설정

- **페이지 로드**: 페이즈 1 위치로 자동 스크롤
- **새로고침 대응**: 새로고침 시에도 하단 위치 유지
- **다중 실행**: 여러 시점에서 스크롤 위치 보장
  - 즉시 실행
  - 100ms, 500ms, 1초 후 재시도
  - 윈도우 리사이즈 시 실행
  - 페이지 로드 완료 시 실행

### 4. 데이터 연동 및 최적화

#### 4.1. 실제 데이터 연동

- **데이터베이스**: Supabase 연동
- **사용자 프로필**: `user_profiles` 테이블에서 데이터 로드
- **하트 시스템**: `user_hearts` 테이블에서 실시간 데이터
- **페이즈 상태**: `currentPhase` 필드 기반 상태 결정

#### 4.2. 성능 최적화

- **하트 충전**: 불필요한 `refill_heart` 호출 제거
- **타이머 로직**: 효율적인 하트 타이머 구현
- **이미지 최적화**: Next.js Image 컴포넌트 활용
- **네트워크 최적화**: 서버 요청 97% 감소

#### 4.3. 상태 관리

- **Zustand Store**: `gameStore`에 `currentPhase` 필드 추가
- **실시간 업데이트**: 사용자 데이터 실시간 반영
- **기본값 설정**: 최초 회원가입 시 기본 데이터 제공

---

## 🔄 다음 단계 (Phase 5 예정)

### 1. 아이템 시스템 구현

- [ ] 아이템 사용 로직 구현 (오답 삭제, 힌트, 점수 2배, 자동 정답)
- [ ] 아이템 사용 시 포인트 차감 시스템
- [ ] 아이템 효과 적용 및 UI 피드백

### 2. 하트 부족 모달 시스템

- [x] 하트가 0일 때 컨티뉴 모달 구현 ✅
- [x] 광고 시청 유도 시스템 (기본 구조 완료) ✅
- [x] 하트 구매 시스템 ✅

### 3. 설정 메뉴 모달

- [ ] 게임 설정 옵션
- [ ] 사운드/효과음 설정
- [ ] 계정 관리

### 4. 레벨업 연출 시스템

- [ ] 레벨업 시 캐릭터 변화 애니메이션
- [ ] 레벨업 축하 효과
- [ ] 직급별 특별 연출
- [ ] 캐릭터 성장 시스템
- [ ] 업적 시스템 구현

### 5. 최적화 및 개선

- [ ] 성능 최적화 (이미지 최적화, 코드 스플리팅)
- [ ] 접근성 개선
- [ ] 모바일 최적화
- [ ] 오프라인 지원 (PWA)

---

## 📁 주요 파일

### 구현된 파일 (2025-01-27 최신)

- `src/app/game/page.tsx`: 메인 게임 페이지
- `src/app/game/phase1/page.tsx`: Phase 1 스테이지 페이지
- `src/app/game/phase2/page.tsx`: Phase 2 스테이지 페이지
- `src/app/game/phase3/page.tsx`: Phase 3 스테이지 페이지
- `src/app/game/phase4/page.tsx`: Phase 4 스테이지 페이지
- `src/app/game/quiz/page.tsx`: 퀴즈 게임 페이지 (점수/경험치 시스템 포함)
- `src/components/StageButton.tsx`: 재사용 가능한 스테이지 버튼 컴포넌트
- `src/components/QuizChoiceButton.tsx`: 퀴즈 선택지 버튼 컴포넌트
- `src/components/GameHeader.tsx`: 게임 헤더 컴포넌트 (하트 시스템 포함)
- `src/components/HeartShortageModal.tsx`: 하트 부족 모달 컴포넌트 (신규)
- `src/components/StageResultModal.tsx`: 스테이지 결과 모달 컴포넌트 (신규)
- `src/store/gameStore.ts`: 게임 상태 관리 (하트 시스템, 레벨업 시스템 포함)
- `src/store/authStore.ts`: 인증 상태 관리
- `src/services/quizService.ts`: 퀴즈 데이터 서비스 (랜덤 문제 로직 포함)
- `src/services/tossAuthService.ts`: 토스 인증
- `supabase/fix-consume-heart.sql`: 하트 차감 RPC 함수 수정 스크립트
- `supabase/fix-answer-indexes.sql`: 퀴즈 정답 인덱스 수정 스크립트
- `supabase/update-user-progress.sql`: 사용자 진행 상황 업데이트 RPC 함수
- `supabase/complete-stage.sql`: 스테이지 완료 처리 RPC 함수
- `supabase/fix-buy-heart-with-points.sql`: 하트 구매 RPC 함수 수정 스크립트 (신규)
- `supabase/fix-update-user-progress.sql`: 모호한 컬럼 참조 수정 스크립트

### 데이터베이스 (2025-01-27 최신)

- `supabase/schema.sql`: 데이터베이스 스키마
- `user_profiles` 테이블: 사용자 프로필 및 진행 상황 (current_stage 필드 포함)
- `user_hearts` 테이블: 하트 시스템 관리
- `quizzes` 테이블: 퀴즈 문제 데이터 (200개 문제, 난이도별 분류)
- `consume_heart` RPC 함수: 하트 차감 처리 함수
- `update_user_progress` RPC 함수: 점수/경험치/레벨 업데이트 함수
- `buy_heart_with_points` RPC 함수: 포인트로 하트 구매 처리 함수 (수정됨)

---

## 🎯 성과 요약

### 기술적 성과 (2025-01-27 최신)

- **UI 구현**: 완전한 메인 게임 페이지, 스테이지 페이지, 퀴즈 페이지, 결과 모달 UI 구현
- **데이터 연동**: 실시간 데이터베이스 연동 및 하트 시스템 완료
- **게임 메커니즘**: 퀴즈 시스템, 하트 시스템, 점수/경험치 시스템, 레벨업 시스템 완료
- **스테이지 결과**: 성공/실패 모달, 보상 시스템, 페이즈별 라우팅 완료
- **성능 최적화**: 네트워크 요청 최적화, SSR 호환성 확보
- **사용자 경험**: 스크롤, 새로고침, 반응형 시스템 완료
- **랜덤 시스템**: 중복 없는 랜덤 퀴즈 선택 시스템 구현

### 개발 효율성

- **모듈화**: 컴포넌트 및 서비스 분리 (QuizChoiceButton, GameHeader 등)
- **상태 관리**: Zustand를 활용한 효율적인 상태 관리 (하트 시스템 포함)
- **타입 안전성**: TypeScript를 활용한 타입 안전성 확보
- **코드 품질**: 린트 에러 없는 깔끔한 코드, 디버깅 로그 정리
- **재사용성**: StageButton, QuizChoiceButton 등 재사용 가능한 컴포넌트 구현
- **에러 처리**: Supabase RPC 함수 에러 해결, SSR 호환성 확보

### 다음 단계 준비

- **퀴즈 시스템 완성**: 완전한 퀴즈 게임 메커니즘 구현 완료
- **하트 시스템 완성**: 실시간 하트 관리 및 카운트다운 시스템 완료
- **데이터 준비**: 200개 퀴즈 데이터 및 난이도별 분류 완료
- **인프라 준비**: Supabase 인프라, 보안 설정, RPC 함수 완료
- **스테이지 시스템**: 완전한 스테이지 선택, 잠금, 진행 시스템 구현
- **UI/UX 완성**: 모든 주요 페이지의 UI/UX 구현 완료

---

### 17. 페이즈별 스테이지 잠금 시스템 (2025-01-27 완료)

#### 17.1. 문제 해결

- **기존 문제**: 페이즈 1 클리어 후 페이즈 2의 모든 스테이지가 열림
- **원인**: `complete_stage` 함수의 `GREATEST` 함수 잘못된 사용
- **해결**: `GREATEST` 함수 제거, 직접 값 할당으로 수정

#### 17.2. 수정된 로직

- **페이즈 1 스테이지 5 클리어 시**: `current_stage = 1`, `current_phase = 2`
- **페이즈별 잠금**: 각 페이즈에서 현재 스테이지보다 높은 스테이지만 잠금
- **독립적 관리**: 페이즈별로 독립적인 스테이지 잠금 로직

### 18. 레벨업 시스템 완전 구현 (2025-01-27 완료)

#### 18.1. 데이터베이스 레벨업 로직

- **`update_user_progress` 함수 개선**: 레벨업 로직 추가
- **레벨업 공식**: `120 × 1.15^(level-1)` 적용
- **최대 레벨**: 20레벨까지 지원

#### 18.2. 레벨업 보상 시스템

- **하트 자동 회복**: 레벨업 시 하트 +1 (최대 5개)
- **UI 실시간 반영**: 레벨업 즉시 헤더에 반영
- **데이터베이스 동기화**: 클라이언트와 서버 상태 일치

### 19. 캐릭터 이미지 시스템 최적화 (2025-01-27 완료)

#### 19.1. 문제 해결

- **404 에러**: `level-4.png` 존재하지 않는 파일 요청
- **원인**: 퀴즈 페이지에서 직접 `level-${level}.png` 참조
- **해결**: 통일된 `getCharacterImage` 함수 사용

#### 19.2. 이미지 매핑 시스템

- **레벨 1-4**: `level-1.png` 사용
- **레벨 5-9**: `level-5.png` 사용
- **레벨 10-14**: `level-10.png` 사용
- **레벨 15-19**: `level-15.png` 사용
- **레벨 20+**: `level-20.png` 사용

#### 19.3. 캐시 문제 해결

- **쿼리 파라미터**: `?v=${level}` 추가로 캐시 무효화
- **React key**: `key={character-${level}}` 추가로 리렌더링 강제

### 20. 문제 중복 방지 및 난이도 분배 시스템 (2025-01-27 완료)

#### 20.1. 중복 방지 시스템

- **데이터베이스 활용**: `user_quiz_records` 테이블 활용
- **중복 체크**: 이미 푼 문제 제외하고 새로운 문제만 제공
- **사용자별 관리**: 각 사용자별로 독립적인 진행 기록 관리

#### 20.2. 난이도 분배 시스템

- **스테이지 1-2**: 쉬움 난이도 문제만 제공
- **스테이지 3-4**: 보통 난이도 문제만 제공
- **스테이지 5**: 어려움 난이도 문제만 제공

#### 20.3. 퀴즈 기록 저장

- **답안 제출 시**: 모든 답안을 `user_quiz_records`에 저장
- **중복 방지**: 다음에 같은 문제가 나오지 않도록 기록
- **진행 추적**: 사용자의 퀴즈 진행 상황 완전 추적

**🚀 Phase 4 완료! 퀴즈 게임 메커니즘 구현이 완료되었습니다. 이제 아이템 시스템과 스테이지 완료 시스템 구현을 시작할 준비가 되었습니다.**
